# 15. 异常

- [15. 异常](#15-异常)
  - [15.0. 引言](#150-引言)
  - [15.1. 概念](#151-概念)
  - [15.2. 基本的异常](#152-基本的异常)
  - [15.3. 异常捕获](#153-异常捕获)
    - [15.3.1. try 块](#1531-try-块)
    - [15.3.2. 异常处理程序](#1532-异常处理程序)
  - [15.4. 创建自己的异常](#154-创建自己的异常)
    - [15.4.1. 异常与日志记录](#1541-异常与日志记录)

## 15.0. 引言

- 改进错误恢复机制是增加代码稳健性的最强有力的方法之一。

- 捕捉错误的理想时机是在编译时，也就是在你试图运行程序之前。然而，并不是所有的错误都能在编译时发现。其他问题必须在运行时通过某种正规手段来处理，这种手段应该支持这个错误的源头将适当的信息传递给知道如何正确处理该难题的某个接受者。

- **要创建一个稳定的系统，每个组建都必须是稳健的**。

- Java 使用异常提供了一个一致的错误报告模型，从而使组件可以将问题可靠地传达给客户代码；

- 在 Java 中，异常处理的目标时减少当前的代码量，从而使创建大型、可靠的程序更简单易行，并且这样也使我们更加确信，应用程序不会存在未处理的错误。异常不是特别难学，而且可以为我们的项目提供直接和显著的好处。

## 15.1. 概念

- `异常（exception）` 这个词在英语中有 “感到意外” 的意思。当问题出现时，我们可能不知道如何处理，但是我们知道，我们不能愉快地继续下去了 —— 我们必须停下来，而某个人活某个地方必须想办法解决问题。但是在当前的上下文中，我们没有足够的信心来解决这个问题。所以我们把问题提交给更上层的上下文，那里有人能做出正确的决策。

## 15.2. 基本的异常

- `异常情形（exceptional condition）` 是指阻止当前方法或作用域继续执行的问题。
  
  - 当抛出一个异常时，会发生几件事。首先，异常对象会被创建出来，这一点和任何 Java 对象都一样：使用 `new` 创建，放在堆上。当前执行路径停止，指向这个异常对象的引用被从当前上下文推出来。现在异常处理机制接管控制，并开始寻找可以继续执行这个程序的适当位置。这个适当位置就是 “异常处理程序” ，它的工作是从问题中恢复，这样程序才能要么尝试另一条路径，要么继续执行。

  - 通过创建一个表示我们的信息的对象，并将其“抛”出当前上下文，我们可以将关于这个错误的信息发送到一个更大的上下文中。这叫作 **抛出异常** ，如下所示：

    ``` java
    throw new NullPointerException();
    ```

  - 异常使得我们可以把自己所做的每件事情都看作一个事务，而异常可以为这些事物提供保护：“。。。在分布式计算中需要异常处理，这个事物的基本前提。事物等同于计算机中的合同法。如果有任何地方出了问题，我们将放弃整个计算。“ 我们也可以把异常看作一个内置的 ”撤销（undo）“ 系统，因为可以在程序中小心地设置各种恢复点。如果程序的某个地方出了问题，异常可以实现 “撤销” ，回到程序中某个已知的稳定点。

- `异常参数`

  - 和 Java 中的任何对象一样，我们总是使用 `new` 在堆上创建异常，它会分配存储空间并调用构造器。所有标准异常类都有两个构造器：<u>*第一个时无参构造器；第二个接受一个 `String` 参数，用于在异常中放置相关信息。*</u>

    ``` java
    throw new NullPointerException("t == null");
    ```

  - 关键字 `throw` 会产生激光有趣的结果。在用 `new` 创建一个异常对象后，我们把生成的引用交给了 `throw` 。这个对象实际上是从方法中“返回”的，尽管其类型通常不是我们设计让这个方法返回的。一个简单的方法是把异常处理看成是另一种返回机制，虽然类比走得太远也会有麻烦。我们也可以通过抛出一个异常来退出正常的作用域。不管是哪种情况，都会返回一个异常对象，并退出当前的方法或作用域。

  - `Throwable` 是异常类型的根类；

## 15.3. 异常捕获

- 要弄清楚如何捕捉异常，首先必须理解 `被守护区域（guarded region）` 的概念。这是一段可能会产生异常的代码，后面跟着处理这些异常的代码。

### 15.3.1. try 块

- 如果我们正处于一个方法之中，并抛出了异常，该方法将在抛出异常的过程中退出。如果不希望退出，可以在其中设置一个特殊的块来捕获这个异常。因为要在这里“尝试”各种方法调用，所以它称为 `try块`。

``` java
try{
    // 可能会产生异常的代码
}
```

### 15.3.2. 异常处理程序

- 被抛出的异常总是要在某个地方结束。这个 “地方” 就是异常处理程序，我们可以为每种异常类型编写一个。异常处理程序紧跟在 `try` 块之后，用关键字 `catch` 来表示：

``` java
try {
    // 可能会产生异常的代码
} catch (Type1 id1) {
    // 处理 Type1 类型的异常
} catch (Type2 id2) {
    // 处理 Type2 类型的异常
} catch (Type3 id3) {
    // 处理 Type3 类型的异常
}
```

- > 注意：在 `try` 块中，许多不同的方法调用可能会参数相同的异常，但我们只需要一个针对这种类型的处理程序；

- 终止与恢复

  - Java 支持 `终止模型（termination）` ，在这种情况下，我们假设错误是如此严重，以至于无法返回到异常发生的地方。抛出异常的人断定情况已经无法挽回，而且他们也不想再回来；

  - `恢复模型（resumption）`。它意味着异常处理程序有望通过某些工作来修正这种情况，然后重新尝试出现问题的方法，假定第二次可以成功。如果想要使用恢复模型，这意味着我们仍然希望在处理完异常后继续执行。

## 15.4. 创建自己的异常

- 不必拘泥于使用 Java 中已有的异常。 Java 的异常体系无法预见我们可能会遇到的所有错误，所以我们可以创建自己的异常，来表示自己的库可能会遇到的某个特殊问题。

- 要创建自己的异常类，可以继承现有的异常类，最好是与我们要定义的新异常含义接近的。创建一个新的异常类型的最简单方法就是，让编译器为我们创建无参构造器，几乎不需要任何代码。

    ``` java
    class SimpleException extends Exception {
    }
    ```

  - 参考案例：[InheritingExceptions.java](./code/src/main/java/pers/xgo/onjava/chapter15_exceptions/InheritingExceptions.java)

- 还可以创建一个异常类，使其带有接受一个 `String` 参数的构造器

    ``` java
    class MyException extends Exception {
        public MyException() {
            super();
        }

        public MyException(String message) {
            super(message);
        }
    }
    ```

  - 参考案例：[FullConstructors.java](./code/src/main/java/pers/xgo/onjava/chapter15_exceptions/FullConstructors.java)

  - 处理程序中调用了 `Throwable` ( `Exception` 类就是从它继承而来的 ) 的一个方法： `printStackTrace()` 。 如输出所示，这会输出到达异常发生点点方法调用序列的信息。在这里，这些信息被发送到了 `System.out` ，并自动地被捕获和显示在输出中。然而，如果调用默认的版本：`e.printStackTrace()` ;

### 15.4.1. 异常与日志记录

- 我们可以使用 `java.util.logging` 工具将输出记录到 `日志` 中。基本的日志记录操作很简单，如下演示：

  - 参考案例：[LoggingExceptions.java](./code/src/main/java/pers/xgo/onjava/chapter15_exceptions/LoggingExceptions.java)

- `LoggingExceptions` 用到的方法非常方便，因为它把所有的日志继承设施都构建在类异常类本身之中，因此它可以自动工作，无须客户程序员干预。然而，更常见的情况是捕捉别人的异常，并将其记录到日志中，所以我们必须在异常处理程序中生成日志信息；
  - 参考案例：[LoggingExceptions2.java](./code/src/main/java/pers/xgo/onjava/chapter15_exceptions/LoggingExceptions2.java)

- 创建自己的异常的过程还可以更进一步。我们可以添加更多构造器和成员。
  - 参考案例：[MyFeatures.java](./code/src/main/java/pers/xgo/onjava/chapter15_exceptions/MyFeatures.java)